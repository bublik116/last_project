<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Синтез и сумма сигналов (аудио)</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header>
    <h1>Сумматор сигналов (20 Гц – 20 кГц)</h1>
    <p class="subtitle">Интерактивный синтез аудио-сигналов и их сумма. WebAudio + Canvas, без бэкенда.</p>
  </header>

  <section class="controls">
    <div class="control-group">
      <label for="sampleRate">Частота дискретизации (Fs):</label>
      <select id="sampleRate">
        <option value="44100" selected>44100 Гц</option>
        <option value="48000">48000 Гц</option>
      </select>
    </div>
    <div class="control-group">
      <label for="durationSec">Длительность окна (с):</label>
      <input id="durationSec" type="number" min="0.1" step="0.1" value="2.0" />
    </div>
    <div class="control-group">
      <label for="normalize">Нормализация уровня:</label>
      <input id="normalize" type="checkbox" checked />
    </div>
    <div class="control-group">
      <button id="renderBtn">Рассчитать</button>
      <button id="playBtn">Воспроизвести</button>
      <button id="stopBtn" disabled>Стоп</button>
      <button id="exportWavBtn">Экспорт WAV</button>
      <button id="exportCsvBtn">Экспорт CSV</button>
    </div>
  </section>

  <!-- Раздел формантного синтеза речи -->
  <section class="speech hidden">
    <h2>Речь (формантный синтез)</h2>
    <div class="control-group">
      <label for="vowelPreset">Гласная (пресет):</label>
      <select id="vowelPreset">
        <option value="a" selected>А [a]</option>
        <option value="e">Э [e]</option>
        <option value="i">И [i]</option>
        <option value="o">О [o]</option>
        <option value="u">У [u]</option>
      </select>
      <label for="gender">Голос:</label>
      <select id="gender">
        <option value="male" selected>Мужской</option>
        <option value="female">Женский</option>
      </select>
    </div>
    <div class="control-group">
      <label for="f0Range">F0 (Гц):</label>
      <input id="f0Range" type="range" min="60" max="300" step="1" value="120" />
      <input id="f0Number" type="number" min="60" max="300" step="1" value="120" />
      <label for="durSpeech">Длительность (с):</label>
      <input id="durSpeech" type="number" min="0.2" step="0.1" value="1.0" />
    </div>
    <div class="control-group">
      <label for="voicedLevel">Voiced:</label>
      <input id="voicedLevel" type="range" min="0" max="1" step="0.01" value="1" />
      <label for="noiseLevel">Noise:</label>
      <input id="noiseLevel" type="range" min="0" max="1" step="0.01" value="0.05" />
    </div>
    <div class="control-group">
      <label for="glottalModel">Источник:</label>
      <select id="glottalModel">
        <option value="impulse" selected>Импульсы</option>
        <option value="rosenberg">Rosenberg</option>
      </select>
      <label for="Oq">Oq</label>
      <input id="Oq" type="number" min="0.3" max="0.9" step="0.01" value="0.6" />
      <label for="Rq">Rq</label>
      <input id="Rq" type="number" min="0.05" max="0.4" step="0.01" value="0.1" />
      <label for="preEmph">Преэмфаза</label>
      <input id="preEmph" type="checkbox" />
      <label for="preEmphA">a</label>
      <input id="preEmphA" type="number" min="0" max="0.99" step="0.01" value="0.97" />
    </div>
    <div class="control-group">
      <label for="tractModel">Тракт:</label>
      <select id="tractModel">
        <option value="parallel">Параллель</option>
        <option value="cascade" selected>Каскад</option>
      </select>
      <button id="demoVowelsBtn">Демо: а-э-и-о-у</button>
    </div>
    <div class="control-group">
      <label for="vowelPresetFrom">Морфинг: от</label>
      <select id="vowelPresetFrom">
        <option value="a" selected>А [a]</option>
        <option value="e">Э [e]</option>
        <option value="i">И [i]</option>
        <option value="o">О [o]</option>
        <option value="u">У [u]</option>
      </select>
      <label for="vowelPresetTo">до</label>
      <select id="vowelPresetTo">
        <option value="a">А [a]</option>
        <option value="e">Э [e]</option>
        <option value="i" selected>И [i]</option>
        <option value="o">О [o]</option>
        <option value="u">У [u]</option>
      </select>
      <label for="morphAlpha">α</label>
      <input id="morphAlpha" type="range" min="0" max="1" step="0.01" value="0" />
    </div>
    <div class="source-card">
      <div class="source-row">
        <div><label>F1 (Гц)</label><input id="F1" type="number" min="100" max="1200" step="10" value="730" /></div>
        <div><label>B1 (Гц)</label><input id="B1" type="number" min="50" max="500" step="10" value="80" /></div>
        <div><label>F2 (Гц)</label><input id="F2" type="number" min="300" max="3000" step="10" value="1090" /></div>
        <div><label>B2 (Гц)</label><input id="B2" type="number" min="50" max="500" step="10" value="90" /></div>
        <div><label>F3 (Гц)</label><input id="F3" type="number" min="1000" max="5000" step="10" value="2440" /></div>
        <div><label>B3 (Гц)</label><input id="B3" type="number" min="50" max="600" step="10" value="120" /></div>
      </div>
    </div>
    <div class="control-group">
      <button id="synthSpeechBtn">Синтезировать</button>
      <button id="playSpeechBtn">Проиграть</button>
      <button id="exportSpeechBtn">Экспорт WAV</button>
    </div>
    <div class="control-group">
      <label for="ttsText">Текст:</label>
      <input id="ttsText" type="text" value="ма ма па па" style="min-width: 320px;" />
      <button id="ttsSpeakBtn">Озвучить текст</button>
    </div>
    <div class="control-group">
      <label for="speechViewMode">Вид:</label>
      <select id="speechViewMode">
        <option value="wave" selected>Осциллограмма</option>
        <option value="spec">Спектр</option>
      </select>
      <label for="speechSpecLog">дБ</label>
      <input id="speechSpecLog" type="checkbox" checked />
      <label for="speechSpecLogX">лог f</label>
      <input id="speechSpecLogX" type="checkbox" />
      <label for="speechSpecHarm">гармоники F0</label>
      <input id="speechSpecHarm" type="checkbox" checked />
      <button id="speechSpecResetZoomBtn">Сброс зума</button>
    </div>
    <canvas id="speechCanvas" width="1000" height="240"></canvas>
    <div id="speechInfo" class="badge"></div>
  </section>

  <section class="sources">
    <h2>Источники сигналов (до 10)</h2>
    <div id="sourcesContainer"></div>
    <div class="control-group">
      <button id="addSourceBtn">Добавить источник</button>
      <button id="clearSourcesBtn">Очистить все</button>
    </div>
  </section>

  <section class="viz">
    <h2>Временная область</h2>
    <div class="control-group">
      <label for="viewLenMsRange">Масштаб окна (мс):</label>
      <input id="viewLenMsRange" type="range" min="5" max="2000" step="1" value="200" />
      <input id="viewLenMsNumber" type="number" min="5" max="2000" step="1" value="200" />
      <button id="fitAllBtn">Весь сигнал</button>
    </div>
    <div class="control-group">
      <label for="viewOffsetMsRange">Смещение окна (мс):</label>
      <input id="viewOffsetMsRange" type="range" min="0" max="0" step="1" value="0" />
      <input id="viewOffsetMsNumber" type="number" min="0" max="0" step="1" value="0" />
    </div>
    <canvas id="waveCanvas" width="1000" height="240"></canvas>
    <div id="warnings" class="warnings"></div>
  </section>

  <!-- Панель вкладок визуализации -->
  <section class="tabs">
    <button id="tabTime" class="tab active">Время</button>
    <button id="tabFFT" class="tab">Спектр (FFT)</button>
    <button id="tabSpeech" class="tab">Речь (форманты)</button>
  </section>

  <!-- Раздел спектра -->
  <section class="spectrum hidden">
    <h2>Спектр (FFT)</h2>
    <div class="control-group">
      <label for="fftSize">Размер FFT:</label>
      <select id="fftSize">
        <option value="2048">2048</option>
        <option value="4096" selected>4096</option>
        <option value="8192">8192</option>
        <option value="16384">16384</option>
      </select>
    </div>
    <div class="control-group">
      <label for="windowType">Окно:</label>
      <select id="windowType">
        <option value="rect" selected>Прямоугольное</option>
        <option value="hann">Hann</option>
        <option value="hamming">Hamming</option>
      </select>
    </div>
    <div class="control-group">
      <label for="fftLog">Логарифмическая шкала (дБ):</label>
      <input id="fftLog" type="checkbox" checked />
    </div>
    <div class="control-group">
      <label for="peakCount">Пики (шт):</label>
      <input id="peakCount" type="number" min="0" max="20" step="1" value="5" />
      <button id="recalcFFTBtn">Пересчитать спектр</button>
      <button id="fftResetZoomBtn">Сброс зума</button>
    </div>
    <canvas id="fftCanvas" width="1000" height="240"></canvas>
    <div id="fftInfo" class="badge"></div>
  </section>

  <footer>
    <small>Подсказка: для корректного старта аудио необходимо взаимодействие пользователя (кнопка «Воспроизвести»).</small>
  </footer>

  <script defer src="app.js"></script>
</body>
</html>
